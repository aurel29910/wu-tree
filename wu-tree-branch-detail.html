<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wu Tree - Business & Finance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #87CEEB 0%, #FFB6C1 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .phone-frame {
            width: 375px;
            height: 812px;
            background: linear-gradient(135deg, #B4E1D4 0%, #D4B4E1 50%, #F5C5D4 100%);
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
            position: relative;
        }

        .status-bar {
            height: 44px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            color: rgba(255,255,255,0.95);
            font-size: 14px;
            font-weight: 500;
            background: rgba(0,0,0,0.1);
        }

        .header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
        }

        .back-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-title {
            flex: 1;
        }

        .branch-name {
            color: white;
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .branch-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            margin-top: 2px;
        }

        .canvas-container {
            position: relative;
            height: calc(100% - 44px - 66px - 70px);
            overflow: hidden;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .center-node {
            cursor: pointer;
        }

        .goal-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .goal-node:hover circle {
            r: 32;
        }

        .why-node {
            cursor: pointer;
            opacity: 0.85;
        }

        .branch-line {
            stroke: rgba(255,255,255,0.4);
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
        }

        .node-circle {
            fill: rgba(255,255,255,0.25);
            stroke: rgba(255,255,255,0.5);
            stroke-width: 2;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
        }

        .center-circle {
            fill: linear-gradient(135deg, #FFD700, #FFA500);
            animation: pulse-center 3s ease-in-out infinite;
        }

        @keyframes pulse-center {
            0%, 100% { r: 35; }
            50% { r: 40; }
        }

        .node-text {
            fill: white;
            font-size: 12px;
            font-weight: 600;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .center-text {
            font-size: 28px;
        }

        .why-text {
            font-size: 10px;
            font-style: italic;
            opacity: 0.9;
        }

        .add-button {
            position: fixed;
            bottom: 30px;
            right: calc(50% - 167px);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF69B4, #FF1493);
            border: none;
            color: white;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255,105,180,0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .add-button:active {
            transform: scale(0.9);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 375px;
            height: 812px;
            background: rgba(0,0,0,0.6);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #B4E1D4 0%, #D4B4E1 50%, #F5C5D4 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 15px;
        }

        .form-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.6);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF69B4, #FF1493);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .manage-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 375px;
            height: 812px;
            background: rgba(0,0,0,0.6);
            z-index: 300;
            align-items: center;
            justify-content: center;
        }

        .manage-modal.active {
            display: flex;
        }

        .manage-modal-content {
            background: linear-gradient(135deg, #B4E1D4 0%, #D4B4E1 50%, #F5C5D4 100%);
            border-radius: 20px;
            padding: 25px;
            width: 85%;
            max-height: 70%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .manage-modal-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .manage-option {
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .manage-option:active {
            transform: scale(0.97);
            background: rgba(255,255,255,0.35);
        }

        .option-icon {
            font-size: 24px;
        }

        .option-text {
            flex: 1;
        }

        .option-title {
            color: white;
            font-size: 15px;
            font-weight: 600;
        }

        .option-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            margin-top: 2px;
        }

        .delete-option {
            border-color: rgba(255,0,0,0.4);
            background: rgba(255,0,0,0.15);
        }

        .emoji-btn {
            font-size: 24px;
            background: rgba(255,255,255,0.25);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .emoji-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: scale(1.1);
        }

        .emoji-btn:active {
            transform: scale(0.95);
        }

        .info-text {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            text-align: center;
            margin-top: 15px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="status-bar">
            <span>9:41</span>
            <span>üì∂ üîã</span>
        </div>

        <div class="header">
            <button class="back-button" onclick="goBack()">‚Üê</button>
            <div class="header-title">
                <div class="branch-name">üí∞ Business & Finance</div>
                <div class="branch-subtitle" id="subtitle">Vue arborescente</div>
            </div>
        </div>

        <div class="canvas-container">
            <svg id="treeSvg" viewBox="0 0 375 650">
                <!-- Les branches seront g√©n√©r√©es ici -->
            </svg>
        </div>

        <button class="add-button" onclick="openAddModal()">+</button>

        <!-- Modal pour ajouter -->
        <div class="modal" id="addModal">
            <div class="modal-content">
                <h2 class="modal-title" id="modalTitle">Nouvel √©l√©ment</h2>
                
                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="goalInput" placeholder="Ex: 100k‚Ç¨ en 2026">
                </div>

                <div class="form-group">
                    <label class="form-label">Emoji</label>
                    <input type="text" class="form-input" id="emojiInput" placeholder="üí∞" maxlength="2" style="font-size: 24px; text-align: center;">
                </div>

                <div style="margin-top: 15px;">
                    <button onclick="toggleEmojiPicker()" style="width: 100%; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; padding: 10px; color: white; cursor: pointer; font-size: 14px;">
                        üòä Choisir un emoji
                    </button>
                </div>

                <div id="emojiPicker" style="display: none; margin-top: 10px; max-height: 150px; overflow-y: auto; background: rgba(255,255,255,0.15); border-radius: 12px; padding: 10px;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                        <button onclick="selectEmoji('üí∞')" class="emoji-btn">üí∞</button>
                        <button onclick="selectEmoji('‚Çø')" class="emoji-btn">‚Çø</button>
                        <button onclick="selectEmoji('üíé')" class="emoji-btn">üíé</button>
                        <button onclick="selectEmoji('üéØ')" class="emoji-btn">üéØ</button>
                        <button onclick="selectEmoji('üöÄ')" class="emoji-btn">üöÄ</button>
                        <button onclick="selectEmoji('üìà')" class="emoji-btn">üìà</button>
                        <button onclick="selectEmoji('üå≥')" class="emoji-btn">üå≥</button>
                        <button onclick="selectEmoji('üéµ')" class="emoji-btn">üéµ</button>
                        <button onclick="selectEmoji('üìå')" class="emoji-btn">üìå</button>
                        <button onclick="selectEmoji('‚ö°')" class="emoji-btn">‚ö°</button>
                        <button onclick="selectEmoji('üî•')" class="emoji-btn">üî•</button>
                        <button onclick="selectEmoji('üí™')" class="emoji-btn">üí™</button>
                        <button onclick="selectEmoji('üß†')" class="emoji-btn">üß†</button>
                        <button onclick="selectEmoji('üé®')" class="emoji-btn">üé®</button>
                        <button onclick="selectEmoji('‚úàÔ∏è')" class="emoji-btn">‚úàÔ∏è</button>
                        <button onclick="selectEmoji('üè†')" class="emoji-btn">üè†</button>
                        <button onclick="selectEmoji('üöó')" class="emoji-btn">üöó</button>
                        <button onclick="selectEmoji('üì±')" class="emoji-btn">üì±</button>
                        <button onclick="selectEmoji('üíª')" class="emoji-btn">üíª</button>
                        <button onclick="selectEmoji('üìä')" class="emoji-btn">üìä</button>
                        <button onclick="selectEmoji('üí°')" class="emoji-btn">üí°</button>
                        <button onclick="selectEmoji('üåü')" class="emoji-btn">üåü</button>
                        <button onclick="selectEmoji('‚≠ê')" class="emoji-btn">‚≠ê</button>
                        <button onclick="selectEmoji('üéì')" class="emoji-btn">üéì</button>
                        <button onclick="selectEmoji('üìö')" class="emoji-btn">üìö</button>
                        <button onclick="selectEmoji('üèÜ')" class="emoji-btn">üèÜ</button>
                        <button onclick="selectEmoji('üëë')" class="emoji-btn">üëë</button>
                        <button onclick="selectEmoji('üåç')" class="emoji-btn">üåç</button>
                        <button onclick="selectEmoji('üåà')" class="emoji-btn">üåà</button>
                        <button onclick="selectEmoji('‚ù§Ô∏è')" class="emoji-btn">‚ù§Ô∏è</button>
                        <button onclick="selectEmoji('üíö')" class="emoji-btn">üíö</button>
                        <button onclick="selectEmoji('üßò')" class="emoji-btn">üßò</button>
                        <button onclick="selectEmoji('üôè')" class="emoji-btn">üôè</button>
                        <button onclick="selectEmoji('üíµ')" class="emoji-btn">üíµ</button>
                        <button onclick="selectEmoji('üí∏')" class="emoji-btn">üí∏</button>
                    </div>
                </div>

                <p class="info-text" id="addInfo"></p>

                <button class="btn btn-primary" onclick="saveGoal()">Cr√©er</button>
                <button class="btn btn-secondary" onclick="closeAddModal()">Annuler</button>
            </div>
        </div>

        <!-- Modal de gestion d'une branche -->
        <div class="manage-modal" id="manageModal">
            <div class="manage-modal-content">
                <h2 class="manage-modal-title" id="manageTitle">G√©rer</h2>
                
                <div class="manage-option" onclick="window.actionAddSubBranch()">
                    <div class="option-icon">‚ûï</div>
                    <div class="option-text">
                        <div class="option-title">Ajouter une sous-branche</div>
                        <div class="option-subtitle">Cr√©er un nouveau n≈ìud enfant</div>
                    </div>
                </div>

                <div class="manage-option" onclick="window.actionEditBranch()">
                    <div class="option-icon">‚úèÔ∏è</div>
                    <div class="option-text">
                        <div class="option-title">Modifier</div>
                        <div class="option-subtitle">Changer le titre ou l'emoji</div>
                    </div>
                </div>

                <div class="manage-option delete-option" onclick="window.actionDeleteBranch()">
                    <div class="option-icon">üóëÔ∏è</div>
                    <div class="option-text">
                        <div class="option-title">Supprimer</div>
                        <div class="option-subtitle">Retirer cette branche et ses enfants</div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="window.closeManageModal()">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        let ultimateGoal = null;
        let mainBranches = [];
        const svg = document.getElementById('treeSvg');
        const centerX = 187.5;
        const centerY = 580; // TOI en bas

        // Charger les donn√©es depuis localStorage
        function loadData() {
            const savedGoal = localStorage.getItem('wutree_business_ultimate_goal');
            const savedBranches = localStorage.getItem('wutree_business_branches');
            
            ultimateGoal = savedGoal ? JSON.parse(savedGoal) : null;
            mainBranches = savedBranches ? JSON.parse(savedBranches) : [];
            
            renderTree();
        }

        // Sauvegarder les donn√©es
        function saveData() {
            if (ultimateGoal) {
                localStorage.setItem('wutree_business_ultimate_goal', JSON.stringify(ultimateGoal));
            }
            localStorage.setItem('wutree_business_branches', JSON.stringify(mainBranches));
        }

        // Rendre l'arbre complet
        function renderTree() {
            svg.innerHTML = '';

            // Cr√©er les gradients
            createGradients();

            // 1. N≈ìud central (TOI) en BAS
            drawCenterNode();

            // 2. Dessiner les branches principales
            if (mainBranches.length > 0) {
                drawMainBranches();
            }

            // 3. Objectif ultime en HAUT (si d√©fini)
            if (ultimateGoal) {
                drawUltimateGoal();
            }

            // Mettre √† jour le sous-titre
            const totalNodes = mainBranches.reduce((sum, branch) => {
                return sum + 1 + (branch.subBranches ? branch.subBranches.length : 0);
            }, 0);
            document.getElementById('subtitle').textContent = 
                `${totalNodes} n≈ìud${totalNodes > 1 ? 's' : ''}`;
        }

        function createGradients() {
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            
            // Gradient pour le centre (TOI)
            const centerGrad = createGradient('centerGradient', '#FFD700', '#FFA500');
            defs.appendChild(centerGrad);
            
            // Gradient pour l'objectif ultime
            const goalGrad = createGradient('goalGradient', '#FF69B4', '#FF1493');
            defs.appendChild(goalGrad);
            
            svg.appendChild(defs);
        }

        function createGradient(id, color1, color2) {
            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradient.setAttribute('id', id);
            gradient.setAttribute('x1', '0%');
            gradient.setAttribute('y1', '0%');
            gradient.setAttribute('x2', '100%');
            gradient.setAttribute('y2', '100%');
            
            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('style', `stop-color:${color1};stop-opacity:1`);
            
            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '100%');
            stop2.setAttribute('style', `stop-color:${color2};stop-opacity:1`);
            
            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            
            return gradient;
        }

        function drawCenterNode() {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.classList.add('center-node');
            
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', centerX);
            circle.setAttribute('cy', centerY);
            circle.setAttribute('r', 35);
            circle.style.fill = 'url(#centerGradient)';
            circle.style.filter = 'drop-shadow(0 4px 12px rgba(255,215,0,0.5))';

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', centerX);
            text.setAttribute('y', centerY + 12);
            text.classList.add('node-text', 'center-text');
            text.textContent = 'üßò';

            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', centerX);
            label.setAttribute('y', centerY + 55);
            label.classList.add('node-text');
            label.style.fontSize = '11px';
            label.textContent = 'TOI';

            group.appendChild(circle);
            group.appendChild(text);
            group.appendChild(label);
            svg.appendChild(group);
        }

        function drawMainBranches() {
            const branchCount = mainBranches.length;
            const spacing = 280 / Math.max(branchCount, 1);
            const startX = centerX - (spacing * (branchCount - 1)) / 2;

            mainBranches.forEach((branch, index) => {
                const branchX = startX + (spacing * index);
                const branchY = 380;

                // Ligne vers la branche principale
                drawLine(centerX, centerY, branchX, branchY, 3);

                // N≈ìud branche principale
                drawBranchNode(branchX, branchY, branch, index);

                // Sous-branches si elles existent
                if (branch.subBranches && branch.subBranches.length > 0) {
                    drawSubBranches(branchX, branchY, branch.subBranches, index);
                }
            });
        }

        function drawBranchNode(x, y, branch, branchIndex) {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.classList.add('goal-node');
            group.onclick = () => manageBranch(branchIndex);

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', 30);
            circle.style.fill = 'rgba(144,238,144,0.3)';
            circle.style.stroke = 'rgba(255,255,255,0.6)';
            circle.style.strokeWidth = '2';
            circle.style.filter = 'drop-shadow(0 2px 8px rgba(0,0,0,0.2))';

            const emoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            emoji.setAttribute('x', x);
            emoji.setAttribute('y', y + 8);
            emoji.classList.add('node-text');
            emoji.style.fontSize = '22px';
            emoji.textContent = branch.emoji || 'üéØ';

            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', x);
            label.setAttribute('y', y - 38);
            label.classList.add('node-text');
            label.textContent = truncate(branch.title, 12);

            group.appendChild(circle);
            group.appendChild(emoji);
            group.appendChild(label);
            svg.appendChild(group);
        }

        function drawSubBranches(parentX, parentY, subBranches, branchIndex, path = []) {
            const subCount = subBranches.length;
            const subSpacing = Math.max(70, 140 / (path.length + 1));
            const subStartX = parentX - (subSpacing * (subCount - 1)) / 2;
            const levelHeight = 100;
            const subY = parentY - levelHeight;

            subBranches.forEach((subBranch, subIndex) => {
                const subX = subStartX + (subSpacing * subIndex);

                // Ligne vers sous-branche
                drawLine(parentX, parentY, subX, subY, 2, true);

                // N≈ìud sous-branche
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.classList.add('why-node');
                
                const currentPath = [...path, subIndex];
                group.onclick = () => manageBranch(branchIndex, currentPath);

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', subX);
                circle.setAttribute('cy', subY);
                circle.setAttribute('r', 22);
                circle.style.fill = 'rgba(255,182,193,0.3)';
                circle.style.stroke = 'rgba(255,255,255,0.5)';
                circle.style.strokeWidth = '1.5';

                const emoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                emoji.setAttribute('x', subX);
                emoji.setAttribute('y', subY + 6);
                emoji.classList.add('node-text');
                emoji.style.fontSize = '16px';
                emoji.textContent = subBranch.emoji || 'üìå';

                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', subX);
                label.setAttribute('y', subY - 28);
                label.classList.add('node-text', 'why-text');
                label.textContent = truncate(subBranch.title, 10);

                group.appendChild(circle);
                group.appendChild(emoji);
                group.appendChild(label);
                svg.appendChild(group);

                // R√âCURSION : Si cette sous-branche a des sous-branches, les dessiner
                if (subBranch.subBranches && subBranch.subBranches.length > 0) {
                    drawSubBranches(subX, subY, subBranch.subBranches, branchIndex, currentPath);
                }
            });
        }

        function drawUltimateGoal() {
            const goalY = 80;

            // Lignes depuis toutes les branches principales vers l'objectif
            mainBranches.forEach((_, index) => {
                const branchCount = mainBranches.length;
                const spacing = 280 / Math.max(branchCount, 1);
                const startX = centerX - (spacing * (branchCount - 1)) / 2;
                const branchX = startX + (spacing * index);
                const branchY = 380;

                drawLine(branchX, branchY - 30, centerX, goalY + 40, 2, true);
            });

            // N≈ìud objectif ultime
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.classList.add('goal-node');
            group.onclick = () => editUltimateGoal();

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', centerX);
            circle.setAttribute('cy', goalY);
            circle.setAttribute('r', 40);
            circle.style.fill = 'url(#goalGradient)';
            circle.style.filter = 'drop-shadow(0 4px 16px rgba(255,105,180,0.6))';

            const emoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            emoji.setAttribute('x', centerX);
            emoji.setAttribute('y', goalY + 10);
            emoji.classList.add('node-text');
            emoji.style.fontSize = '28px';
            emoji.textContent = ultimateGoal.emoji || 'üí∞';

            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', centerX);
            label.setAttribute('y', goalY - 48);
            label.classList.add('node-text');
            label.style.fontSize = '14px';
            label.style.fontWeight = '700';
            label.textContent = truncate(ultimateGoal.title, 18);

            group.appendChild(circle);
            group.appendChild(emoji);
            group.appendChild(label);
            svg.appendChild(group);
        }

        function drawLine(x1, y1, x2, y2, width = 2, dashed = false) {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.classList.add('branch-line');
            line.style.strokeWidth = width;
            if (dashed) {
                line.style.strokeDasharray = '4,4';
            }
            svg.appendChild(line);
        }

        function truncate(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        let currentManageContext = null; // {branchIndex, path}
        let currentAddContext = null; // {branchIndex, path} ou null pour objectif ultime

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
        }

        function selectEmoji(emoji) {
            document.getElementById('emojiInput').value = emoji;
            // Optionnel : fermer le picker apr√®s s√©lection
            // document.getElementById('emojiPicker').style.display = 'none';
        }

        function openAddModal() {
            const modal = document.getElementById('addModal');
            const title = document.getElementById('modalTitle');
            const info = document.getElementById('addInfo');
            
            if (!ultimateGoal) {
                title.textContent = 'üéØ Objectif ultime';
                document.getElementById('goalInput').placeholder = 'Ex: 100k‚Ç¨ en 2026';
                document.getElementById('emojiInput').value = 'üí∞';
                info.textContent = 'üí° C\'est ton objectif final, celui que tout le reste va nourrir';
                currentAddContext = null;
            } else {
                title.textContent = '‚ûï Nouvelle branche';
                document.getElementById('goalInput').placeholder = 'Ex: Crypto, Wu Tree...';
                document.getElementById('emojiInput').value = 'üéØ';
                info.textContent = 'üí° Une branche principale vers ton objectif';
                currentAddContext = 'main';
            }
            
            document.getElementById('goalInput').value = '';
            modal.classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            currentAddContext = null;
        }

        function saveGoal() {
            const title = document.getElementById('goalInput').value.trim();
            const emoji = document.getElementById('emojiInput').value.trim() || 'üéØ';

            alert('saveGoal appel√©e ! title=' + title + ', currentAddContext=' + JSON.stringify(currentAddContext));

            if (!title) {
                alert('Merci de renseigner un titre');
                return;
            }

            if (currentAddContext === null) {
                alert('Cr√©ation objectif ultime');
                // Cr√©er l'objectif ultime
                ultimateGoal = { title, emoji };
            } else if (currentAddContext === 'main') {
                alert('Cr√©ation branche principale');
                // Ajouter une branche principale
                mainBranches.push({
                    id: Date.now(),
                    title,
                    emoji,
                    subBranches: []
                });
            } else {
                alert('Cr√©ation sous-branche');
                // Ajouter une sous-branche
                const { branchIndex, path } = currentAddContext;
                alert('branchIndex=' + branchIndex + ', path=' + JSON.stringify(path));
                
                const newSubBranch = {
                    id: Date.now(),
                    title,
                    emoji,
                    subBranches: []
                };

                if (path.length === 0) {
                    alert('Ajout direct √† branche principale');
                    mainBranches[branchIndex].subBranches.push(newSubBranch);
                } else {
                    alert('Navigation dans l\'arbre');
                    let current = mainBranches[branchIndex];
                    for (let i = 0; i < path.length; i++) {
                        current = current.subBranches[path[i]];
                    }
                    if (!current.subBranches) current.subBranches = [];
                    current.subBranches.push(newSubBranch);
                }
                
                alert('Sous-branche ajout√©e ! Sauvegarde...');
            }

            saveData();
            alert('Donn√©es sauvegard√©es ! Rerender...');
            renderTree();
            closeAddModal();
            alert('Termin√© !');
        }

        function manageBranch(branchIndex, path = []) {
            currentManageContext = { branchIndex, path };
            
            const branch = path.length === 0 
                ? mainBranches[branchIndex]
                : getSubBranchByPath(branchIndex, path);
            
            document.getElementById('manageTitle').textContent = branch.title;
            document.getElementById('manageModal').classList.add('active');
        }

        function closeManageModal() {
            document.getElementById('manageModal').classList.remove('active');
            currentManageContext = null;
        }

        function actionAddSubBranch() {
            alert('actionAddSubBranch appel√©e !');
            
            if (!currentManageContext) {
                alert('ERREUR : currentManageContext est null !');
                return;
            }
            
            closeManageModal();
            
            const { branchIndex, path } = currentManageContext;
            alert('Contexte : branchIndex=' + branchIndex + ', path=' + JSON.stringify(path));
            
            currentAddContext = { branchIndex, path };
            
            const modal = document.getElementById('addModal');
            document.getElementById('modalTitle').textContent = '‚ûï Nouvelle sous-branche';
            document.getElementById('goalInput').value = '';
            document.getElementById('goalInput').placeholder = 'Ex: Trading, MVP...';
            document.getElementById('emojiInput').value = 'üìå';
            document.getElementById('addInfo').textContent = 'üí° Une √©tape vers cet objectif';
            
            modal.classList.add('active');
        }

        function actionEditBranch() {
            closeManageModal();
            
            const { branchIndex, path } = currentManageContext;
            const branch = path.length === 0 
                ? mainBranches[branchIndex]
                : getSubBranchByPath(branchIndex, path);
            
            const newTitle = prompt('Nouveau titre :', branch.title);
            if (newTitle && newTitle.trim()) {
                branch.title = newTitle.trim();
                
                const newEmoji = prompt('Nouvel emoji :', branch.emoji);
                if (newEmoji && newEmoji.trim()) {
                    branch.emoji = newEmoji.trim();
                }
                
                saveData();
                renderTree();
            }
        }

        function actionDeleteBranch() {
            const { branchIndex, path } = currentManageContext;
            const branch = path.length === 0 
                ? mainBranches[branchIndex]
                : getSubBranchByPath(branchIndex, path);
            
            closeManageModal();
            
            if (!confirm(`Supprimer "${branch.title}" et toutes ses sous-branches ?`)) {
                return;
            }

            if (path.length === 0) {
                mainBranches.splice(branchIndex, 1);
            } else if (path.length === 1) {
                mainBranches[branchIndex].subBranches.splice(path[0], 1);
            } else {
                let current = mainBranches[branchIndex];
                for (let i = 0; i < path.length - 1; i++) {
                    current = current.subBranches[path[i]];
                }
                current.subBranches.splice(path[path.length - 1], 1);
            }
            
            saveData();
            renderTree();
        }

        function getSubBranchByPath(branchIndex, path) {
            let current = mainBranches[branchIndex];
            for (const index of path) {
                current = current.subBranches[index];
            }
            return current;
        }

        function editUltimateGoal() {
            const newTitle = prompt('Modifier l\'objectif ultime :', ultimateGoal.title);
            if (newTitle && newTitle.trim()) {
                ultimateGoal.title = newTitle.trim();
                
                const newEmoji = prompt('Nouvel emoji :', ultimateGoal.emoji);
                if (newEmoji && newEmoji.trim()) {
                    ultimateGoal.emoji = newEmoji.trim();
                }
                
                saveData();
                renderTree();
            }
        }

        function goBack() {
            window.location.href = 'wu-tree-branch-detail.html';
        }

        // Exposer toutes les fonctions dans window pour les onclick
        window.selectEmoji = selectEmoji;
        window.toggleEmojiPicker = toggleEmojiPicker;
        window.openAddModal = openAddModal;
        window.closeAddModal = closeAddModal;
        window.saveGoal = saveGoal;
        window.manageBranch = manageBranch;
        window.closeManageModal = closeManageModal;
        window.actionAddSubBranch = actionAddSubBranch;
        window.actionEditBranch = actionEditBranch;
        window.actionDeleteBranch = actionDeleteBranch;
        window.editUltimateGoal = editUltimateGoal;
        window.goBack = goBack;

        // Charger au d√©marrage
        loadData();
    </script>
</body>
</html>
