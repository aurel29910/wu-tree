<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wu Tree - Business & Finance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #87CEEB 0%, #FFB6C1 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .phone-frame {
            width: 375px;
            height: 812px;
            background: linear-gradient(135deg, #B4E1D4 0%, #D4B4E1 50%, #F5C5D4 100%);
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
            position: relative;
        }

        .status-bar {
            height: 44px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            color: rgba(255,255,255,0.95);
            font-size: 14px;
            font-weight: 500;
            background: rgba(0,0,0,0.1);
        }

        .header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
        }

        .back-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-title {
            flex: 1;
        }

        .branch-name {
            color: white;
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .branch-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            margin-top: 2px;
        }

        .canvas-container {
            position: relative;
            height: calc(100% - 44px - 66px - 70px);
            overflow: hidden;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .center-node {
            cursor: pointer;
        }

        .goal-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .goal-node:hover circle {
            r: 32;
        }

        .why-node {
            cursor: pointer;
            opacity: 0.85;
        }

        .branch-line {
            stroke: rgba(255,255,255,0.4);
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
        }

        .node-circle {
            fill: rgba(255,255,255,0.25);
            stroke: rgba(255,255,255,0.5);
            stroke-width: 2;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
        }

        .center-circle {
            fill: linear-gradient(135deg, #FFD700, #FFA500);
            animation: pulse-center 3s ease-in-out infinite;
        }

        @keyframes pulse-center {
            0%, 100% { r: 35; }
            50% { r: 40; }
        }

        .node-text {
            fill: white;
            font-size: 12px;
            font-weight: 600;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .center-text {
            font-size: 28px;
        }

        .why-text {
            font-size: 10px;
            font-style: italic;
            opacity: 0.9;
        }

        .add-button {
            position: fixed;
            bottom: 30px;
            right: calc(50% - 167px);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF69B4, #FF1493);
            border: none;
            color: white;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255,105,180,0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .add-button:active {
            transform: scale(0.9);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 375px;
            height: 812px;
            background: rgba(0,0,0,0.6);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #B4E1D4 0%, #D4B4E1 50%, #F5C5D4 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 15px;
        }

        .form-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.6);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF69B4, #FF1493);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .info-text {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            text-align: center;
            margin-top: 15px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="status-bar">
            <span>9:41</span>
            <span>üì∂ üîã</span>
        </div>

        <div class="header">
            <button class="back-button" onclick="goBack()">‚Üê</button>
            <div class="header-title">
                <div class="branch-name">üí∞ Business & Finance</div>
                <div class="branch-subtitle" id="subtitle">Vue arborescente</div>
            </div>
        </div>

        <div class="canvas-container">
            <svg id="treeSvg" viewBox="0 0 375 650">
                <!-- Les branches seront g√©n√©r√©es ici -->
            </svg>
        </div>

        <button class="add-button" onclick="openAddModal()">+</button>

        <!-- Modal pour ajouter -->
        <div class="modal" id="addModal">
            <div class="modal-content">
                <h2 class="modal-title" id="modalTitle">Nouvel √©l√©ment</h2>
                
                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="goalInput" placeholder="Ex: 100k‚Ç¨ en 2026">
                </div>

                <div class="form-group">
                    <label class="form-label">Emoji (optionnel)</label>
                    <input type="text" class="form-input" id="emojiInput" placeholder="üí∞" maxlength="2">
                </div>

                <div id="showSubBranchField" style="display:none;">
                    <p class="info-text">üí° Les branches repr√©sentent les diff√©rents moyens d'atteindre ton objectif</p>
                </div>

                <button class="btn btn-primary" onclick="saveGoal()">Cr√©er</button>
                <button class="btn btn-secondary" onclick="closeAddModal()">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        let ultimateGoal = null;
        let mainBranches = [];
        const svg = document.getElementById('treeSvg');
        const centerX = 187.5;
        const centerY = 580; // TOI en bas

        // Charger les donn√©es depuis localStorage
        function loadData() {
            const savedGoal = localStorage.getItem('wutree_business_ultimate_goal');
            const savedBranches = localStorage.getItem('wutree_business_branches');
            
            ultimateGoal = savedGoal ? JSON.parse(savedGoal) : null;
            mainBranches = savedBranches ? JSON.parse(savedBranches) : [];
            
            renderTree();
        }

        // Sauvegarder les donn√©es
        function saveData() {
            if (ultimateGoal) {
                localStorage.setItem('wutree_business_ultimate_goal', JSON.stringify(ultimateGoal));
            }
            localStorage.setItem('wutree_business_branches', JSON.stringify(mainBranches));
        }

        // Rendre l'arbre complet
        function renderTree() {
            svg.innerHTML = '';

            // Cr√©er les gradients
            createGradients();

            // 1. N≈ìud central (TOI) en BAS
            drawCenterNode();

            // 2. Dessiner les branches principales
            if (mainBranches.length > 0) {
                drawMainBranches();
            }

            // 3. Objectif ultime en HAUT (si d√©fini)
            if (ultimateGoal) {
                drawUltimateGoal();
            }

            // Mettre √† jour le sous-titre
            const totalNodes = mainBranches.reduce((sum, branch) => {
                return sum + 1 + (branch.subBranches ? branch.subBranches.length : 0);
            }, 0);
            document.getElementById('subtitle').textContent = 
                `${totalNodes} n≈ìud${totalNodes > 1 ? 's' : ''}`;
        }

        function createGradients() {
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            
            // Gradient pour le centre (TOI)
            const centerGrad = createGradient('centerGradient', '#FFD700', '#FFA500');
            defs.appendChild(centerGrad);
            
            // Gradient pour l'objectif ultime
            const goalGrad = createGradient('goalGradient', '#FF69B4', '#FF1493');
            defs.appendChild(goalGrad);
            
            svg.appendChild(defs);
        }

        function createGradient(id, color1, color2) {
            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradient.setAttribute('id', id);
            gradient.setAttribute('x1', '0%');
            gradient.setAttribute('y1', '0%');
            gradient.setAttribute('x2', '100%');
            gradient.setAttribute('y2', '100%');
            
            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('style', `stop-color:${color1};stop-opacity:1`);
            
            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '100%');
            stop2.setAttribute('style', `stop-color:${color2};stop-opacity:1`);
            
            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            
            return gradient;
        }

        function drawCenterNode() {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.classList.add('center-node');
            
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', centerX);
            circle.setAttribute('cy', centerY);
            circle.setAttribute('r', 35);
            circle.style.fill = 'url(#centerGradient)';
            circle.style.filter = 'drop-shadow(0 4px 12px rgba(255,215,0,0.5))';

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', centerX);
            text.setAttribute('y', centerY + 12);
            text.classList.add('node-text', 'center-text');
            text.textContent = 'üßò';

            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', centerX);
            label.setAttribute('y', centerY + 55);
            label.classList.add('node-text');
            label.style.fontSize = '11px';
            label.textContent = 'TOI';

            group.appendChild(circle);
            group.appendChild(text);
            group.appendChild(label);
            svg.appendChild(group);
        }

        function drawMainBranches() {
            const branchCount = mainBranches.length;
            const spacing = 280 / Math.max(branchCount, 1);
            const startX = centerX - (spacing * (branchCount - 1)) / 2;

            mainBranches.forEach((branch, index) => {
                const branchX = startX + (spacing * index);
                const branchY = 380;

                // Ligne vers la branche principale
                drawLine(centerX, centerY, branchX, branchY, 3);

                // N≈ìud branche principale
                drawBranchNode(branchX, branchY, branch, index);

                // Sous-branches si elles existent
                if (branch.subBranches && branch.subBranches.length > 0) {
                    drawSubBranches(branchX, branchY, branch.subBranches, index);
                }
            });
        }

        function drawBranchNode(x, y, branch, branchIndex) {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.classList.add('goal-node');
            group.onclick = () => manageBranch(branchIndex);

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', 30);
            circle.style.fill = 'rgba(144,238,144,0.3)';
            circle.style.stroke = 'rgba(255,255,255,0.6)';
            circle.style.strokeWidth = '2';
            circle.style.filter = 'drop-shadow(0 2px 8px rgba(0,0,0,0.2))';

            const emoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            emoji.setAttribute('x', x);
            emoji.setAttribute('y', y + 8);
            emoji.classList.add('node-text');
            emoji.style.fontSize = '22px';
            emoji.textContent = branch.emoji || 'üéØ';

            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', x);
            label.setAttribute('y', y - 38);
            label.classList.add('node-text');
            label.textContent = truncate(branch.title, 12);

            group.appendChild(circle);
            group.appendChild(emoji);
            group.appendChild(label);
            svg.appendChild(group);
        }

        function drawSubBranches(parentX, parentY, subBranches, branchIndex) {
            const subCount = subBranches.length;
            const subSpacing = 80;
            const subStartX = parentX - (subSpacing * (subCount - 1)) / 2;

            subBranches.forEach((subBranch, subIndex) => {
                const subX = subStartX + (subSpacing * subIndex);
                const subY = parentY - 120;

                // Ligne vers sous-branche
                drawLine(parentX, parentY, subX, subY, 2, true);

                // N≈ìud sous-branche
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.classList.add('why-node');
                group.onclick = () => deleteSubBranch(branchIndex, subIndex);

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', subX);
                circle.setAttribute('cy', subY);
                circle.setAttribute('r', 22);
                circle.style.fill = 'rgba(255,182,193,0.3)';
                circle.style.stroke = 'rgba(255,255,255,0.5)';
                circle.style.strokeWidth = '1.5';

                const emoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                emoji.setAttribute('x', subX);
                emoji.setAttribute('y', subY + 6);
                emoji.classList.add('node-text');
                emoji.style.fontSize = '16px';
                emoji.textContent = subBranch.emoji || 'üìå';

                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', subX);
                label.setAttribute('y', subY - 28);
                label.classList.add('node-text', 'why-text');
                label.textContent = truncate(subBranch.title, 10);

                group.appendChild(circle);
                group.appendChild(emoji);
                group.appendChild(label);
                svg.appendChild(group);
            });
        }

        function drawUltimateGoal() {
            const goalY = 80;

            // Lignes depuis toutes les branches principales vers l'objectif
            mainBranches.forEach((_, index) => {
                const branchCount = mainBranches.length;
                const spacing = 280 / Math.max(branchCount, 1);
                const startX = centerX - (spacing * (branchCount - 1)) / 2;
                const branchX = startX + (spacing * index);
                const branchY = 380;

                drawLine(branchX, branchY - 30, centerX, goalY + 40, 2, true);
            });

            // N≈ìud objectif ultime
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.classList.add('goal-node');
            group.onclick = () => editUltimateGoal();

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', centerX);
            circle.setAttribute('cy', goalY);
            circle.setAttribute('r', 40);
            circle.style.fill = 'url(#goalGradient)';
            circle.style.filter = 'drop-shadow(0 4px 16px rgba(255,105,180,0.6))';

            const emoji = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            emoji.setAttribute('x', centerX);
            emoji.setAttribute('y', goalY + 10);
            emoji.classList.add('node-text');
            emoji.style.fontSize = '28px';
            emoji.textContent = ultimateGoal.emoji || 'üí∞';

            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', centerX);
            label.setAttribute('y', goalY - 48);
            label.classList.add('node-text');
            label.style.fontSize = '14px';
            label.style.fontWeight = '700';
            label.textContent = truncate(ultimateGoal.title, 18);

            group.appendChild(circle);
            group.appendChild(emoji);
            group.appendChild(label);
            svg.appendChild(group);
        }

        function drawLine(x1, y1, x2, y2, width = 2, dashed = false) {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.classList.add('branch-line');
            line.style.strokeWidth = width;
            if (dashed) {
                line.style.strokeDasharray = '4,4';
            }
            svg.appendChild(line);
        }

        function truncate(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function openAddModal() {
            const modal = document.getElementById('addModal');
            const title = document.getElementById('modalTitle');
            
            if (!ultimateGoal) {
                title.textContent = 'Objectif ultime';
                document.getElementById('goalInput').placeholder = 'Ex: 100k‚Ç¨ en 2026';
                document.getElementById('emojiInput').value = 'üí∞';
            } else {
                title.textContent = 'Nouvelle branche';
                document.getElementById('goalInput').placeholder = 'Ex: Crypto, Wu Tree...';
                document.getElementById('emojiInput').value = 'üéØ';
            }
            
            document.getElementById('goalInput').value = '';
            document.getElementById('showSubBranchField').style.display = mainBranches.length > 0 ? 'block' : 'none';
            
            modal.classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        function saveGoal() {
            const title = document.getElementById('goalInput').value.trim();
            const emoji = document.getElementById('emojiInput').value.trim() || 'üéØ';

            if (!title) {
                alert('Merci de renseigner un titre');
                return;
            }

            if (!ultimateGoal) {
                // Cr√©er l'objectif ultime
                ultimateGoal = { title, emoji };
            } else {
                // Ajouter une branche principale
                mainBranches.push({
                    id: Date.now(),
                    title,
                    emoji,
                    subBranches: []
                });
            }

            saveData();
            renderTree();
            closeAddModal();
        }

        function manageBranch(index) {
            const branch = mainBranches[index];
            const action = prompt(`Branche: ${branch.title}\n\n1 = Ajouter sous-branche\n2 = Supprimer cette branche\n\nTapez le num√©ro :`);
            
            if (action === '1') {
                addSubBranch(index);
            } else if (action === '2') {
                if (confirm(`Supprimer "${branch.title}" et toutes ses sous-branches ?`)) {
                    mainBranches.splice(index, 1);
                    saveData();
                    renderTree();
                }
            }
        }

        function addSubBranch(branchIndex) {
            const title = prompt('Nom de la sous-branche :');
            if (!title || !title.trim()) return;

            const emoji = prompt('Emoji (optionnel) :') || 'üìå';

            mainBranches[branchIndex].subBranches.push({
                id: Date.now(),
                title: title.trim(),
                emoji: emoji.trim()
            });

            saveData();
            renderTree();
        }

        function deleteSubBranch(branchIndex, subIndex) {
            const subBranch = mainBranches[branchIndex].subBranches[subIndex];
            if (confirm(`Supprimer "${subBranch.title}" ?`)) {
                mainBranches[branchIndex].subBranches.splice(subIndex, 1);
                saveData();
                renderTree();
            }
        }

        function editUltimateGoal() {
            if (confirm('Modifier l\'objectif ultime ?')) {
                const newTitle = prompt('Nouvel objectif :', ultimateGoal.title);
                if (newTitle && newTitle.trim()) {
                    ultimateGoal.title = newTitle.trim();
                    saveData();
                    renderTree();
                }
            }
        }

        function goBack() {
            window.location.href = 'wu-tree-branch-detail.html';
        }

        // Charger au d√©marrage
        loadData();
    </script>
</body>
</html>
